use_inline_resources

action :install do
	name = new_resource.name

	filename = "node-#{name}.tar"

	raven_deploy_tarball filename do
		directory new_resource.directory
		notifies :run, "bash[node-install-#{name}-deps]", :immediately
	end

	if ::File.exists?("/vagrant") then
		vagrant_params = "--no-same-owner"
	end

	if node.attribute?(:opsworks) then
		chown_cmd = "chown -R www-data: ."
	end

 	bash "node-install-#{name}-deps" do
		action :nothing
		cwd new_resource.directory
		if ::File::exists?("/vagrant") then
			user "vagrant"
		else
			user "root"
		end
		code <<-EOH
			ls *.tgz | xargs -n1 tar x #{vagrant_params} -f
			#{chown_cmd}
			(cd .. && npm rebuild)
		EOH
	end
end
